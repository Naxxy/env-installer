# macOS installer using Homebrew.
# - Normal packages: brew install
# - Casks: brew install --cask
#
# (Fail fast if brew is missing; you can add a brew bootstrap later.)

- name: Check brew exists
  ansible.builtin.command: brew --version
  register: brew_check
  changed_when: false
  failed_when: false

- name: Fail if Homebrew missing
  ansible.builtin.fail:
    msg: "Homebrew ('brew') is required but not installed. Install Homebrew first."
  when: brew_check.rc != 0

# Treat cask as true-only. If cask is missing OR explicitly false -> normal package install.
- name: Install non-cask packages
  ansible.builtin.command: >
    brew install {{
      (
        install_packages_list
        | rejectattr('cask', 'defined')
        | map(attribute='name')
        | list
      )
      +
      (
        install_packages_list
        | selectattr('cask', 'defined')
        | rejectattr('cask')
        | map(attribute='name')
        | list
      )
      | unique
      | join(' ')
    }}
  when: >
    (
      (
        install_packages_list | rejectattr('cask', 'defined') | list | length
      )
      +
      (
        install_packages_list | selectattr('cask', 'defined') | rejectattr('cask') | list | length
      )
    ) > 0

- name: Install cask packages
  ansible.builtin.command: >
    brew install --cask {{
      (install_packages_list
        | selectattr('cask', 'defined')
        | selectattr('cask')
        | map(attribute='name')
        | list
      ) | join(' ')
    }}
  when: >
    (install_packages_list | selectattr('cask', 'defined') | selectattr('cask') | list | length) > 0
