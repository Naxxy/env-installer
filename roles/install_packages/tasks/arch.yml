# Arch-family installer:
# - Repo packages: pacman -S --needed
# - AUR packages (simple heuristic): name ends with "-bin" -> yay
#   (Fail fast if yay isn't present)

- name: Ensure pacman is available
  ansible.builtin.command: pacman --version
  changed_when: false

- name: Check if yay is available
  ansible.builtin.command: yay --version
  register: yay_check
  changed_when: false
  failed_when: false

- name: Split package list into repo vs aur (heuristic)
  ansible.builtin.set_fact:
    arch_repo_pkgs: "{{ install_packages_list | map(attribute='name') | reject('match', '.*-bin$') | list }}"
    arch_aur_pkgs: "{{ install_packages_list | map(attribute='name') | select('match', '.*-bin$') | list }}"

- name: Install repo packages via pacman
  become: true
  ansible.builtin.command: >
    pacman -S --noconfirm --needed {{ arch_repo_pkgs | join(' ') }}
  register: pacman_install
  changed_when: >-
    pacman_install.stdout is defined and
    ('there is nothing to do' not in (pacman_install.stdout | lower))
  when: arch_repo_pkgs | length > 0

- name: Fail if AUR packages requested but yay missing
  ansible.builtin.fail:
    msg: >-
      AUR packages requested ({{ arch_aur_pkgs }}), but 'yay' is not installed.
      Install yay first, or change the package selection for this feature.
  when:
    - arch_aur_pkgs | length > 0
    - yay_check.rc != 0

- name: Install AUR packages via yay
  ansible.builtin.command: >
    yay -S --noconfirm --needed {{ arch_aur_pkgs | join(' ') }}
  register: yay_install
  changed_when: >-
    yay_install.stdout is defined and
    (
      ('there is nothing to do' not in (yay_install.stdout | lower))
      and
      ('nothing to do' not in (yay_install.stdout | lower))
    )
  when:
    - arch_aur_pkgs | length > 0
    - yay_check.rc == 0
