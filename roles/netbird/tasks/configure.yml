- name: Ensure netbird service is enabled and started (Linux)
  become: true
  ansible.builtin.service:
    name: netbird
    enabled: true
    state: started
  when: env_pkg_family in ["arch", "debian"]

- name: Enroll device (idempotent-ish pattern)
  # In practice youâ€™d check current status first; keep simple for skeleton.
  become: true
  ansible.builtin.command: >
    netbird up
    --setup-key {{ netbird_setup_key | quote }}
    {% if netbird_management_url %} --management-url {{ netbird_management_url | quote }}{% endif %}
  register: netbird_up
  changed_when: "'Connected' in (netbird_up.stdout | default('')) or netbird_up.rc == 0"
  failed_when: netbird_up.rc != 0
