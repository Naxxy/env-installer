# playbooks/_derive_features.yml
# Derives the final feature flags from:
# - profiles (env_profiles -> env_profiles_catalog)
# - overrides (env_feature_overrides)
#
# Produces:
# - install_* booleans (final)
# - install_*_reason strings (debuggable)

- name: Ensure env_profiles is defined
  ansible.builtin.set_fact:
    env_profiles: "{{ env_profiles | default([]) }}"

- name: Ensure env_feature_overrides is defined
  ansible.builtin.set_fact:
    env_feature_overrides: "{{ env_feature_overrides | default({}) }}"

- name: Collect features enabled by profiles
  ansible.builtin.set_fact:
    env_features_from_profiles: >-
      {{
        (env_profiles | default([]))
        | map('extract', env_profiles_catalog)
        | select('defined')
        | list
        | flatten
        | unique
      }}

- name: Initialize env_feature_reasons
  ansible.builtin.set_fact:
    env_feature_reasons: {}

- name: Derive final feature flags (profiles + overrides; default=false)
  ansible.builtin.set_fact:
    "{{ item }}": >-
      {{
        (
          env_feature_overrides[item]
          if (env_feature_overrides is mapping and (item in env_feature_overrides))
          else
            (
              true
              if (item in (env_features_from_profiles | default([])))
              else
                false
            )
        )
      }}
    env_feature_reasons: >-
      {{
        env_feature_reasons
        | combine({
            item: (
              ('override:' ~ (env_feature_overrides[item] | string))
              if (env_feature_overrides is mapping and (item in env_feature_overrides))
              else
                (
                  'profile'
                  if (item in (env_features_from_profiles | default([])))
                  else
                    'default:false'
                )
            )
          }, recursive=True)
      }}
  loop: "{{ env_known_features }}"

- name: Expose per-feature reason variables (install_x_reason)
  ansible.builtin.set_fact:
    "{{ item }}_reason": "{{ env_feature_reasons[item] }}"
  loop: "{{ env_known_features }}"

- name: Debug install plan (clear and explicit)
  ansible.builtin.debug:
    msg:
      env_pkg_family: "{{ env_pkg_family | default('UNSET') }}"
      env_flavor: "{{ env_flavor | default('UNSET') }}"
      env_profiles: "{{ env_profiles }}"
      install_plan: >-
        {{
          dict(
            (
              env_known_features
              | select(lambda k: (vars[k] | default(false)) | bool)
              | list
            )
            |
            zip(
              (
                env_known_features
                | select(lambda k: (vars[k] | default(false)) | bool)
                | map('regex_replace', '^(.*)$', '\\1_reason')
                | map('extract', vars)
                | list
              )
            )
          )
        }}
