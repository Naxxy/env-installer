# roles/netbird/tasks/configure.yml
#
# GOALS
# -----
# 1) Dry-runs (--check) should NOT fail (and should not try to manage systemd or run netbird up).
# 2) Real installs should be idempotent:
#    - If the systemd unit isn't installed yet, run: netbird service install
#    - Then enable/start the service
#    - Then enroll with netbird up if not connected

# -----------------------------
# Linux: systemd unit + service
# -----------------------------

- name: Detect whether systemd knows about netbird.service (Linux)
  become: true
  ansible.builtin.command: systemctl list-unit-files netbird.service --no-legend --no-pager
  register: netbird_unit_files
  changed_when: false
  failed_when: false
  when:
    - env_pkg_family in ["arch", "debian"]

- name: Set fact: netbird systemd unit present (Linux)
  ansible.builtin.set_fact:
    netbird_systemd_unit_present: >-
      {{
        (netbird_unit_files.rc | default(1)) == 0
        and
        (
          (netbird_unit_files.stdout | default('') | trim) != ''
          or
          ('netbird.service' in (netbird_unit_files.stdout | default('')))
        )
      }}
  when:
    - env_pkg_family in ["arch", "debian"]

- name: Dry-run note: would install netbird system service (Linux)
  ansible.builtin.debug:
    msg:
      note: "CHECK MODE: netbird.service not detected; a real run would execute: sudo netbird service install"
      env_pkg_family: "{{ env_pkg_family }}"
      env_flavor: "{{ env_flavor }}"
  when:
    - env_pkg_family in ["arch", "debian"]
    - (netbird_systemd_unit_present | default(false)) | bool == false
    - ansible_check_mode | bool

- name: Install netbird system service (Linux) if missing
  become: true
  ansible.builtin.command: netbird service install
  register: netbird_service_install
  changed_when: true
  failed_when: netbird_service_install.rc != 0
  when:
    - env_pkg_family in ["arch", "debian"]
    - (netbird_systemd_unit_present | default(false)) | bool == false
    - not (ansible_check_mode | bool)

- name: Reload systemd after netbird service install (Linux)
  become: true
  ansible.builtin.command: systemctl daemon-reload
  changed_when: false
  when:
    - env_pkg_family in ["arch", "debian"]
    - netbird_service_install is defined
    - (netbird_service_install is changed) | bool
    - not (ansible_check_mode | bool)

- name: Ensure netbird service is enabled and started (Linux)
  become: true
  ansible.builtin.service:
    name: netbird
    enabled: true
    state: started
  when:
    - env_pkg_family in ["arch", "debian"]
    - not (ansible_check_mode | bool)

# -----------------------------
# Linux: enrollment (netbird up)
# -----------------------------

- name: Check netbird status (Linux)
  become: true
  ansible.builtin.command: netbird status
  register: netbird_status
  changed_when: false
  failed_when: false
  when:
    - env_pkg_family in ["arch", "debian"]
    - not (ansible_check_mode | bool)

- name: Enroll device if not connected (Linux)
  become: true
  ansible.builtin.command: >
    netbird up
    --setup-key {{ netbird_setup_key | quote }}
    {% if netbird_management_url %} --management-url {{ netbird_management_url | quote }}{% endif %}
  register: netbird_up
  changed_when: true
  failed_when: netbird_up.rc != 0
  when: >-
    (env_pkg_family in ["arch", "debian"])
    and not (ansible_check_mode | bool)
    and (
      (netbird_status.rc | default(1)) != 0
      or
      ('connected' not in (netbird_status.stdout | default('') | lower))
    )
