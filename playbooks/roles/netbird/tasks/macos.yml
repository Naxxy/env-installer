# roles/netbird/tasks/macos.yml
# macOS NetBird (CLI-only for now).
# - Install CLI via Homebrew: netbirdio/tap/netbird
# - Ensure the daemon service is installed and started

- name: Install NetBird CLI (macOS)
  ansible.builtin.include_role:
    name: install_packages
  vars:
    install_packages_list:
      - name: "{{ netbird_macos_cli_pkg }}"
        state: present
        cask: false

- name: Check netbird service status (macOS)
  become: true
  ansible.builtin.command: netbird service status
  register: netbird_service_status
  changed_when: false
  failed_when: false

- name: Install netbird service (macOS) if missing
  become: true
  ansible.builtin.command: netbird service install
  register: netbird_service_install
  changed_when: true
  failed_when: netbird_service_install.rc != 0
  when: >-
    (netbird_service_status.rc != 0)
    or
    ('not installed' in (netbird_service_status.stdout | default('') | lower))
    or
    ('not found' in (netbird_service_status.stdout | default('') | lower))

- name: Start netbird service (macOS) if not running
  become: true
  ansible.builtin.command: netbird service start
  register: netbird_service_start
  changed_when: true
  failed_when: netbird_service_start.rc != 0
  when: >-
    (netbird_service_status.rc != 0)
    or
    ('running' not in (netbird_service_status.stdout | default('') | lower))
