# playbooks/features/install_lazyvim.yml
#
# LazyVim is not a package â€” it's a Neovim configuration.
#
# Design rules:
# - Packages installed as root
# - User config installed as the target user (never root)
# - Fail fast if ~/.config/nvim already exists
# - No implicit HOME resolution under sudo

- name: Debug LazyVim feature intent
  ansible.builtin.debug:
    msg:
      feature: install_lazyvim
      enabled: "{{ install_lazyvim }}"
      reason: "{{ install_lazyvim_reason }}"
      pkg_family: "{{ env_pkg_family }}"
      flavor: "{{ env_flavor }}"
      ansible_user: "{{ ansible_user }}"
      ansible_user_dir: "{{ ansible_user_dir }}"

# -----------------------------
# Dependency packages (root)
# -----------------------------

- name: Choose LazyVim dependency packages for this platform
  ansible.builtin.set_fact:
    lazyvim_dep_pkgs: >-
      {{
        (
          env_package_names.lazyvim_deps.arch
          if env_pkg_family == 'arch'
          else
            (
              env_package_names.lazyvim_deps.debian
              if env_pkg_family == 'debian'
              else
                env_package_names.lazyvim_deps.macos
            )
        )
      }}

- name: Build install_packages_list for LazyVim dependencies
  ansible.builtin.set_fact:
    lazyvim_install_packages_list: []

- name: Add LazyVim dependency packages (explicit)
  ansible.builtin.set_fact:
    lazyvim_install_packages_list: "{{ lazyvim_install_packages_list + [ { 'name': item, 'state': 'present' } ] }}"
  loop: "{{ lazyvim_dep_pkgs }}"

- name: Install LazyVim dependencies
  ansible.builtin.include_role:
    name: install_packages
  vars:
    install_packages_list: "{{ lazyvim_install_packages_list }}"

# -----------------------------
# User-level config (NO sudo)
# -----------------------------

- name: Determine LazyVim target directory (user-level)
  ansible.builtin.set_fact:
    lazyvim_nvim_dir: "{{ ansible_user_dir }}/.config/nvim"

- name: Check if ~/.config/nvim already exists
  become: false
  ansible.builtin.stat:
    path: "{{ lazyvim_nvim_dir }}"
  register: lazyvim_nvim_stat

- name: Fail if ~/.config/nvim already exists (avoid clobbering)
  ansible.builtin.fail:
    msg: >-
      LazyVim install would write to {{ lazyvim_nvim_dir }}, but it already exists.
      Move or back it up first, then re-run.
  when: lazyvim_nvim_stat.stat.exists

- name: Ensure ~/.config directory exists
  become: false
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/.config"
    state: directory
    mode: "0755"

- name: Clone LazyVim starter into ~/.config/nvim
  become: false
  ansible.builtin.git:
    repo: "https://github.com/LazyVim/starter"
    dest: "{{ lazyvim_nvim_dir }}"
    depth: 1
    update: false

- name: Remove .git directory (convert to user-owned config)
  become: false
  ansible.builtin.file:
    path: "{{ lazyvim_nvim_dir }}/.git"
    state: absent
